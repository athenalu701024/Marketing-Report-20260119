// --- Calculation & Logic ---
    let catCounts = { Strategy: 0, Visual: 0, Ops: 0 };
    let toolCountsGeneral = {};
    let toolCountsArt = {};
    let totalOld = 0, totalNew = 0;

    groupData.forEach(g => {
        g.tasks.forEach(t => {
            catCounts[t.cat] = (catCounts[t.cat] || 0) + t.freq;
            if (g.id === 'art') {
                toolCountsArt[t.tool] = (toolCountsArt[t.tool] || 0) + t.freq;
            } else {
                toolCountsGeneral[t.tool] = (toolCountsGeneral[t.tool] || 0) + t.freq;
            }
        });
        totalOld += g.monthlyOld; totalNew += g.monthlyNew;
    });

    const totalTasks = Object.values(catCounts).reduce((a,b)=>a+b, 0);
    const catPercentages = [
        Math.round(catCounts.Strategy / totalTasks * 100),
        Math.round(catCounts.Visual / totalTasks * 100),
        Math.round(catCounts.Ops / totalTasks * 100)
    ];

    // NOTE: Manual KPI values in HTML are preserved. Auto-calculation removed.

    // --- DOM Generation Logic (PREVENTS DUPLICATION) ---
    // Only generate content if container is empty (first run or clean state)
    if (document.getElementById('groupContainer').children.length === 0) {
        
        // 1. Tool Lists (Rank Only)
        function renderToolList(countsObj, elementId, colorOverride) {
            const sorted = Object.entries(countsObj).sort((a,b) => b[1] - a[1]).slice(0, 5);
            const el = document.getElementById(elementId);
            
            sorted.forEach(([tool, count], index) => {
                let barColor = colorOverride || '#3b82f6';
                if (!colorOverride && ['XMP','Manus'].includes(tool)) barColor = '#f59e0b';
                
                el.innerHTML += `
                    <div class="tool-list-item">
                        <div class="tool-rank">#${index + 1}</div>
                        <div class="tool-name">
                            <span style="width:8px; height:8px; border-radius:50%; background:${barColor};"></span>
                            ${tool}
                        </div>
                    </div>
                `;
            });
        }
        renderToolList(toolCountsGeneral, 'topToolsGeneral', null);
        renderToolList(toolCountsArt, 'topToolsArt', '#9333ea');

        // 2. Group Cards Generation
        const container = document.getElementById('groupContainer');
        groupData.forEach(g => {
            const card = document.createElement('div');
            card.className = 'group-card';
            card.style.borderTop = `5px solid ${g.color}`;
            
            const rows = g.tasks.map(t => {
                let catColor = t.cat === 'Strategy' ? '#3b82f6' : (t.cat === 'Visual' ? '#a855f7' : '#f59e0b');
                let catName = t.cat === 'Strategy' ? '文案' : (t.cat === 'Visual' ? '視覺' : '數據');
                let saved = t.old - t.new;
                return `<tr><td style="font-weight:600;"><span class="cat-badge" style="background:${catColor}">${catName}</span>${t.name}</td><td><span style="font-size:12px; color:#64748b;">${t.note}</span></td><td><span class="time-badge">${t.old}分</span></td><td><span class="time-badge ai">${t.new}分</span></td><td><span class="diff-badge">⬇ ${saved}分</span></td></tr>`;
            }).join('');

            const descHtml = `<div class="group-desc-box" style="border-left-color: ${g.color}"><div class="group-desc-title" style="color: ${g.color}"><i class="fa-solid fa-bullseye"></i> 核心轉型成效</div><div class="group-desc-text">${g.desc}</div></div>`;

            card.innerHTML = `
                <div class="group-header">
                    <div class="group-title" style="color: ${g.color}"><i class="fa-solid fa-layer-group"></i> ${g.name}</div>
                    <div class="group-stats">
                        <div class="stat-badge"><span style="color: ${g.color}">${(g.monthlyOld/g.monthlyNew).toFixed(1)}倍</span><label>效率提升</label></div>
                        <div class="stat-badge"><span style="color: #10b981">${Math.round(((g.monthlyOld - g.monthlyNew) / g.monthlyOld) * 100)}%</span><label>工時釋放</label></div>
                    </div>
                </div>
                ${descHtml}
                <div class="group-content">
                    <div>
                        <h4 style="margin: 0 0 15px 0; color: #475569;">重點 AI 應用項目</h4>
                        <table class="task-table">
                            <thead><tr><th>任務項目</th><th>應用簡述</th><th>傳統</th><th>AI</th><th>單次節省</th></tr></thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>
                    <div class="gallery-wrapper">
                        <h4 style="margin: 0 0 5px 0; color: #475569;">成果展示畫廊</h4>
                        <div class="img-add-btn" onclick="document.getElementById('file-${g.id}').click()" style="display: flex;">
                            <input type="file" id="file-${g.id}" accept="image/*" multiple style="display:none" onchange="handleImageUpload(this, '${g.id}')">
                            <i class="fa-solid fa-cloud-arrow-up" style="font-size: 30px; margin-bottom: 10px;"></i>
                            <span style="font-weight: 600;">點擊新增圖片</span>
                        </div>
                        <div class="gallery-grid" id="gallery-${g.id}"></div>
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
    }

    // --- Charts (Always Re-Draw) ---
    new Chart(document.getElementById('categoryChart').getContext('2d'), {
        type: 'doughnut',
        data: { labels: ['文案與策略', '視覺與影音', '營運與數據'], datasets: [{ data: catPercentages, backgroundColor: ['#3b82f6', '#a855f7', '#f59e0b'], borderWidth: 0 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { color: '#fff', font: { weight: 'bold' }, formatter: (v) => v + '%' } }, cutout: '65%' },
        plugins: [ChartDataLabels]
    });

    new Chart(document.getElementById('valueShiftChart').getContext('2d'), {
        type: 'bar',
        data: { labels: groupData.map(g => g.name), datasets: [{ label: '傳統 P3/P4', data: groupData.map(g => (g.monthlyOld * 0.55 / 60).toFixed(0)), backgroundColor: '#ef4444', stack: 'Before' }, { label: '傳統 P1/P2', data: groupData.map(g => (g.monthlyOld * 0.45 / 60).toFixed(0)), backgroundColor: '#0369a1', stack: 'Before' }, { label: 'AI後 P3/P4', data: groupData.map(g => (g.monthlyNew * 0.65 / 60).toFixed(0)), backgroundColor: '#fca5a5', stack: 'After' }, { label: 'AI後 P1/P2', data: groupData.map(g => (168 - (g.monthlyNew * 0.65 / 60)).toFixed(0)), backgroundColor: '#0ea5e9', stack: 'After' }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { max: 180, title: { display: true, text: '小時 (Hours)' } } } }
    });

    // --- Helper Functions (Preserved) ---
    function handleImageUpload(input, id) {
        if (input.files && input.files.length > 0) {
            const gallery = document.getElementById(`gallery-${id}`);
            Array.from(input.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const div = document.createElement('div');
                    div.className = 'gallery-item';
                    div.setAttribute('onclick', "viewImage(this.querySelector('img').src)");
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    div.appendChild(img);
                    gallery.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }
    }

    window.viewImage = function(src) {
        document.getElementById("myLightbox").style.display = "flex";
        document.getElementById("img01").src = src;
    }
    window.closeLightbox = function() {
        document.getElementById("myLightbox").style.display = "none";
    }

    function saveOfflineFile() {
        const clone = document.documentElement.cloneNode(true);
        const bodyClone = clone.querySelector('body');
        if (bodyClone) bodyClone.classList.add('static-mode');
        
        const fab = clone.querySelector('.fab-container');
        if(fab) fab.remove();
        const uploadBtns = clone.querySelectorAll('.img-add-btn');
        uploadBtns.forEach(btn => btn.style.display = 'none');
        const lb = clone.querySelector('.lightbox');
        if(lb) lb.style.display = 'none';

        const htmlContent = "<!DOCTYPE html>\n" + clone.outerHTML;
        const blob = new Blob([htmlContent], { type: 'text/html' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        const dateStr = new Date().toISOString().split('T')[0];
        link.download = `行銷部AI報告_最終展示版_${dateStr}.html`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        alert("匯出成功！");
    }